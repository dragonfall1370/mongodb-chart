apiVersion: v1
kind: ConfigMap
metadata:
  name: haproxy-mongo-cm
  namespace: {{ .Values.namespace }}
  labels:
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/name: {{ include "mongodb-chart.name" . }}
    app.kubernetes.io/component: haproxy
data:
  haproxy.cfg: |
    global
        log stdout format raw daemon
        maxconn 2048
        # Required for external-check
        external-check
        insecure-fork-wanted

    defaults
        mode tcp
        timeout connect 5s
        timeout client  1m
        timeout server  1m

    frontend f_mongo
        bind *:27017
        default_backend b_mongo

    backend b_mongo
        mode tcp
        balance first

        # External primary check â€“  calls /usr/local/bin/check_mongo_primary.sh <host> <port>
        option external-check
        external-check path /usr/local/bin
        external-check command check_mongo_primary.sh

        # Three RS members behind the headless service
        server mongo-0 mongo-mongodb-chart-0.mongo-mongodb-chart-headless.{{ .Values.namespace }}.svc.cluster.local:27017 check inter 2s fall 2 rise 1
        server mongo-1 mongo-mongodb-chart-1.mongo-mongodb-chart-headless.{{ .Values.namespace }}.svc.cluster.local:27017 check inter 2s fall 2 rise 1
        server mongo-2 mongo-mongodb-chart-2.mongo-mongodb-chart-headless.{{ .Values.namespace }}.svc.cluster.local:27017 check inter 2s fall 2 rise 1