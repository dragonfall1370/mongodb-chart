apiVersion: v1
kind: ConfigMap
metadata:
  name: haproxy-mongo-cm
  namespace: {{ .Values.namespace }}
  labels:
    app.kubernetes.io/name: haproxy-mongo
    app.kubernetes.io/instance: mongo
data:
  haproxy.cfg: |
    global
        log stdout format raw daemon
        maxconn 2048

    defaults
        mode tcp
        timeout connect 5s
        timeout client  1m
        timeout server  1m

    frontend f_mongo
        bind *:27017
        default_backend b_mongo

    backend b_mongo
        mode tcp
        balance first

        # Enable external checks for all servers in this backend
        option external-check
        external-check path /usr/local/bin
        external-check command check_mongo_primary.sh

        # Normal TCP health-check + external-check (no 'external-check' token here)
        server mongo-0 mongo-mongodb-chart-0.mongo-mongodb-chart-headless.mongodb.svc.cluster.local:27017 check inter 2s fall 2 rise 1
        server mongo-1 mongo-mongodb-chart-1.mongo-mongodb-chart-headless.mongodb.svc.cluster.local:27017 check inter 2s fall 2 rise 1
        server mongo-2 mongo-mongodb-chart-2.mongo-mongodb-chart-headless.mongodb.svc.cluster.local:27017 check inter 2s fall 2 rise 1